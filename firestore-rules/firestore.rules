rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Common function to check if the request has valid authentication
    function isAuthenticated() {
      return request.auth != null;
    }
    // Function to check if the timestamp is valid (not too far in the future)
    function isValidTimestamp(ts) {
      return ts is timestamp &&
             ts <= request.time + duration.value(5, 'm');
    }
    // Rule for the top-level 'devices' collection
    match /devices {
      // For now, keep 'if true' for debugging the session/event reads.
      // IMPORTANT: Change this back to 'if isAuthenticated();' later for security.
      allow list: if true;
    }
    // Match individual device documents
    match /devices/{deviceId} {
      // TEMPORARY: Allow cameras to write without auth for testing
      // TODO: Revert this after fixing authentication flow
      allow read: if true;
      allow write: if true;
      // Match sessions subcollection
      match /sessions/{sessionId} { // Path: /devices/{deviceId}/sessions/{sessionId}
        // TEMPORARY: Allow cameras to write without auth for testing
        allow read: if true;
        allow write: if true;
        // This 'events' subcollection is UNDER 'sessions/{sessionId}'
        match /events/{eventId} { // Path: /devices/{deviceId}/sessions/{sessionId}/events/{eventId}
          // TEMPORARY: Allow cameras to write without auth for testing
          allow read: if true;
          allow write: if true;
        }
      }
    }
    // Add this rule for collectionGroup queries on 'events'
    match /{path=**}/events/{eventId} {
      allow read: if isAuthenticated();
    }
    // Allow read access to prompts collection for authenticated users
    match /prompts/{document=**} {
      allow read: if isAuthenticated();
    }
    
    // License key management rules
    match /axis_keys/{keyId} {
      // Only backend services can read/write axis keys
      allow read, write: if false;
    }
    
    // User profile rules
    match /users/{userId} {
      // Users can only read their own profile
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Only backend services can write user profiles
      allow write: if false;
    }
    
    // Admin configuration rules
    match /admin_config/{document} {
      // Only backend services can read/write admin config
      allow read, write: if false;
    }
    
    // Deny access to all other paths by default
    match /{path=**} {
      allow read, write: if false;
    }
  }
}